# Product Inventory & Test Coverage Matrix

This document maps interactive UI components, actions, backend IPCs, the tests that verify them, and coverage status (Green = tested, Yellow = partially tested, Red = untested).

| Location (file)                                                                       | UI Element / Interaction                    | Action / Description                                                                                       | Backend IPC(s)                                                                        | Tests                                                                                                 | Coverage Status                                                                            |
| ------------------------------------------------------------------------------------- | ------------------------------------------- | ---------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------ | ----- |
| `src/components/NoveltyCurveVisualizer.jsx`                                           | Click on curve or peak circles              | Stages a manual split; invokes ARCHITECT:FORCE_SPLIT with `{ frame }`                                      | `ARCHITECT:FORCE_SPLIT`                                                               | `src/components/__tests__/NoveltyCurveVisualizer.test.jsx` (threshold rendering only)                 | Yellow (UI click -> backend not tested)                                                    |
| `src/components/grid/ContextualInspector.tsx`                                         | "Suggest Split" Button (in peaks list)      | Invokes `ARCHITECT:FORCE_SPLIT` with `{ frame }`; also calls `onSplitSection` prop                         | `ARCHITECT:FORCE_SPLIT` (direct), `onSplitSection` callback                           | `src/components/grid/__tests__/ContextualInspector.test.tsx` (UI presence & summary)                  | Yellow (invocation not asserted)                                                           |
| `src/views/SandboxView.tsx`                                                           | "Split Here" Button (ContextualInspector)   | Calls `onSplitSection` prop; currently logs in SandboxView; intended to call handler to persist split      | (handled by `onSplitSection` / Editor actions)                                        | N/A                                                                                                   | Red (prop handler not wired to persistence in SandboxView; no tests)                       |
| `src/components/grid/NavigationTimeline.tsx`                                          | Clicking a significant peak or timeline     | Calls `onSeek(time)` and optionally scrolls to section                                                     | (UI-level callback `onSeek`)                                                          | `src/components/grid/__tests__/NavigationTimeline.test.tsx` (peak click triggers `onSeek`)            | Green                                                                                      |
| `src/views/LibraryView.tsx`                                                           | YouTube Import (URL input + Import button)  | `window.electron.downloadYouTube` + `LIBRARY:CREATE_PROJECT` (after download)                              | `DOWNLOADER:DOWNLOAD` (via exposed function) and `LIBRARY:CREATE_PROJECT`             | `src/__tests__/library.importSong.lyrics.test.js` (lyrics persisted via `createProject`, integration) | Yellow (backend coverage for CREATE_PROJECT exists; UI click not explicitly tested)        |
| `src/components/lyrics/LyricsPanel.tsx` & `src/components/lyrics/LyricDraftPanel.tsx` | Lyrics fetch & edit UI; Lyric draft saving  | `LYRICS:GET` via `useLyrics` + Manual editing persists to analysis payload via EditorContext actions       | `LYRICS:GET`                                                                          | No tests found (no hook/unit tests or component tests)                                                | Red                                                                                        |
| `src/hooks/useLyrics.ts`                                                              | Hook that fetches lyrics using `LYRICS:GET` | Performs fetch via `window.electronAPI.invoke('LYRICS:GET')`                                               | `LYRICS:GET`                                                                          | No tests                                                                                              | Red                                                                                        |
| `electron/services/library.(js                                                        | ts)`                                        | `importSong` / `createProject` logic                                                                       | Creates project, auto-fetches lyrics (`fetchLyrics`) and persists `lyrics_json` to DB | `db.updateProjectLyrics` (internal) & `LIBRARY:CREATE_PROJECT`                                        | `src/__tests__/library.importSong.lyrics.test.js` (integration verifying persisted lyrics) | Green |
| `electron/handlers/architect.js`                                                      | `forceSplitHandler` (business logic)        | Splits a section at a specified frame; updates analysis `structural_map`, persists via DB, rebuilds blocks | `ARCHITECT:FORCE_SPLIT` (handler)                                                     | `src/__tests__/architect.forceSplit.test.js` (integration w/ DB)                                      | Green                                                                                      |
| `electron/midiListener.js`                                                            | MIDI fallbacks                              | Tries native `@julusian/midi`, fallback to `easymidi`, else mock                                           | N/A (no IPC)                                                                          | No tests found for runtime fallback in CI                                                             | Yellow (code path hardened; not tested)                                                    |
| `src/components/tools/AnalysisTuner.jsx`                                              | Analysis preview & commit buttons           | `ANALYSIS:RESEGMENT` preview and commit flows; saves settings in DB via `SET_SETTINGS`                     | `ANALYSIS:RESEGMENT`, `DB:SET_SETTINGS`                                               | No tests                                                                                              | Red                                                                                        |
| `src/views/LibraryView.tsx`                                                           | Re-Analyze Button                           | Invokes `LIBRARY:RE_ANALYZE` to re-compute analysis                                                        | `LIBRARY:RE_ANALYZE`                                                                  | No tests found                                                                                        | Red                                                                                        |
| `src/components/editor/* (SectionEditor, BeatEditor, etc.)`                           | Save/Update Beat & Section UI               | Calls Editor `actions.updateBeat/updateSection` and `actions.saveChanges` to persist changes               | EditorContext actions -> DB save actions (via IPC)                                    | No direct tests for EditorContext actions and `saveChanges`                                           | Red                                                                                        |
| `src/components/grid/ContextualInspector.tsx`                                         | Split Here / Duplicate / Delete Buttons     | Calls `onSplitSection`, `onDuplicateSection`, `onDeleteSection` prop handlers                              | EditorContext callbacks -> Persists via DB (unwired for split in sandbox)             | `ContextualInspector.test.tsx` asserts presence; handlers not invoked                                 | Yellow                                                                                     |

## Notes & Action Items

- High priority tests to add (Red -> Green):
  - `useLyrics` hook unit tests: mock `window.electronAPI.invoke('LYRICS:GET')` and assert state transitions (loading, success, error).
  - `LyricsPanel` component tests: render with mocked `useLyrics` and verify UI states and manual edit flow triggers Editor actions.
  - `AnalysisTuner` UI: test preview & commit flows calling `ANALYSIS:RESEGMENT` and saving settings using the IPC winners; mock `window.electronAPI.invoke`.
  - `LibraryView` UI: test YouTube importer button flow invoking `window.electron.downloadYouTube` and subsequent `LIBRARY:CREATE_PROJECT` call (could be split into separate unit tests for download & createProject).
  - EditorContext action tests: `saveChanges`, `updateBeat`, `updateSection` â€” ensure they call DB saving flows and persist `AudioAnalysis.structural_map`.
- Medium priority tests to add (Yellow -> Green):
  - `NoveltyCurveVisualizer` click behavior: clicking on the graph & peak invokes `ARCHITECT:FORCE_SPLIT` via `window.electronAPI.invoke`. Mock `window.electronAPI.invoke` and assert call is made with appropriate frame.
  - `ContextualInspector` Suggest Split: test that clicking Suggest Split invokes `ARCHITECT:FORCE_SPLIT` and optionally calls `onSplitSection` prop.
  - `ContextualInspector` Split Here: ensure it calls `onSplitSection` prop; add a test in `SandboxView` to wire `onSplitSection` into a persistence flow once implemented.
  - MIDI fallback unit test: simulate failure to require native module and assert fallback to `easymidi` or mock is used to not crash.
- Coverage improvements:
  - Add tests for `Library:RE_ANALYZE`, `Library:ATTACH_MIDI`, and `Library:PROMOTE_TO_BENCHMARK` UI flows to ensure they trigger IPC calls.
  - Verify `EditorContext` hooks with integration tests asserting the state persists to DB after `saveChanges`.

## Proposed Next Steps (Implementation)

- Add unit tests for `useLyrics` and `LyricsPanel` mocking `window.electronAPI.invoke` to assert data handling and error flows. (High priority)
- Add UI tests to assert `ARCHITECT:FORCE_SPLIT` is invoked for both `NoveltyCurveVisualizer` and `ContextualInspector` when clicking a peak or the Suggest Split button respectively. (Medium priority)
- Add tests to make sure `LibraryView` YouTube import triggers download & project creation with proper UI-to-backend validation. (Medium priority)
- Wire `onSplitSection` in `SandboxView` to call backend persistence or architect handler consistently, and verify via an integration test. (High priority)

## Quick Reference

- Green: `electron/handlers/architect.js` forceSplit handler, `electron/services/library` lyrics persistence, novelty utils
- Yellow: `NoveltyCurveVisualizer` threshold renderings, `ContextualInspector` UI presence, `LibraryView` backend import coverage
- Red: Lyrics UI/hook, AnalysisTuner UI, EditorContext save/update actions, MIDI fallback tests, many small UI actions

If you want, I can start adding tests for the highest priority items (e.g., `useLyrics` tests and `NoveltyCurveVisualizer` click tests). Which one should I tackle first?
